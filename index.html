<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Condolence | PM/GoI News Monitor</title>
  <style>
    :root { --bg:#0b0c10; --card:#111218; --ink:#e6e6e6; --muted:#9aa0a6; --accent:#62d2a2; --border:#2a2d36; }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    header{padding:20px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:linear-gradient(180deg,var(--bg) 0%,rgba(11,12,16,.9) 100%);backdrop-filter:blur(6px);z-index:1}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:13px}
    .bar{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    input[type=search]{flex:1;min-width:240px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0e1016;color:#fff;outline:none}
    .pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;color:#fff;text-decoration:none}
    .pill.active{background:var(--accent);border-color:transparent;color:#07120e;font-weight:600}
    main{max-width:960px;margin:22px auto;padding:0 16px}
    .card{border:1px solid var(--border);background:var(--card);border-radius:14px;padding:16px;margin:12px 0;display:grid;grid-template-columns:112px 1fr;gap:14px}
    .card.noimg{grid-template-columns:1fr}
    .thumb{width:112px;height:84px;border-radius:10px;object-fit:cover;border:1px solid var(--border);background:#0e1016}
    .title{font-weight:700;font-size:18px;margin:0 0 6px}
    .title a{color:#fff;text-decoration:none}
    .title a:hover{color:var(--accent)}
    .meta{font-size:13px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .snippet{margin-top:8px;color:#d0d0d0}
    mark{background:transparent;color:var(--accent);font-weight:700}
    .footer{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:14px}
    .btn{border:1px solid var(--border);background:#0e1016;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .count{color:var(--muted);font-size:13px}
    .err{background:#2b1b1b;border:1px solid #553333;color:#f7dddd;padding:10px;border-radius:10px;margin:12px 0}
    .empty{color:#d0d0d0;text-align:center;padding:40px 0}
    .live{display:inline-block;width:8px;height:8px;border-radius:50%;background:#444;margin-left:8px;vertical-align:middle}
    .live.on{background:#62d2a2;box-shadow:0 0 0 4px rgba(98,210,162,.15)}
    @media (max-width:560px){ .card{grid-template-columns:1fr} .thumb{display:none} .title{font-size:16px} }
  </style>
</head>
<body>
<header>
  <h1>Condolence <span id="live" class="live" title="Live"></span></h1>
  <div class="sub">Live list of <b>condolence/demise</b> items your scraper saved in CouchDB.</div>
  <div class="bar">
    <input id="q" type="search" placeholder="Search title or text… (e.g. Philippines, Chennai)"/>
    <a class="pill active" href="#">Condolence</a>
  </div>
</header>

<main>
  <div id="errors"></div>
  <div id="list"></div>
  <div class="footer">
    <div class="count" id="count">—</div>
    <div>
      <button class="btn" id="prev">Prev</button>
      <button class="btn" id="next">Next</button>
    </div>
  </div>
</main>

<script>
/*** CONFIG ***/
const COUCH_URL  = 'https://couch.techstudy.me';   // CouchDB base
const DB_NAME    = 'condolence';                   // DB name
const PAGE_SIZE  = 20;
const ENABLE_LIVE = true;                          // turn off to disable live updates

/*** UTIL ***/
const $ = s => document.querySelector(s);
const sleep = ms => new Promise(r => setTimeout(r, ms));
function toDate(v){
  if (!v) return null;
  if (v instanceof Date) return v;
  if (typeof v === 'number') return new Date(v*1000);
  const t = Date.parse(v);
  return isNaN(t) ? null : new Date(t);
}
function safeHost(u){
  try { return new URL(u).hostname; } catch { return ''; }
}
function fmtPub(iso){
  const d = toDate(iso);
  return d ? d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'}) : '—';
}
function fmtSeen(ts){
  const d = toDate(Number(ts));
  return d ? d.toLocaleString(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '—';
}
function highlight(t=''){
  return t
    .replace(/(condol[a-z]*|demise[a-z]*)/gi, m => `<mark>${m}</mark>`)
    .replace(/(death|deceased)/gi, m => `<mark>${m}</mark>`);
}
function cleanPat(p=''){
  // remove \b and non-capturing bits from pattern strings
  return p.replace(/\\b/g,'').replace(/\(\?:/g,'(').replace(/\)/g,')');
}

/*** STATE ***/
let STORE = new Map();  // id -> doc
let DATA  = [];         // sorted array
let PAGE  = 1;
let currentQuery = '';
let liveToken = 0;

/*** COUCH HELPERS ***/
const base = () => COUCH_URL.replace(/\/$/,'');
function findBody(q){
  const selector = {"matched_patterns": {"$exists": true}};
  if (q){
    selector["$or"] = [
      {"title":{"$regex":`(?i)${q}`}},
      {"snippet":{"$regex":`(?i)${q}`}},
      {"context_snippet":{"$regex":`(?i)${q}`}}
    ];
  }
  // prefer published desc, then first_seen_ts desc
  return { selector, limit: 1000, sort: [{"published":"desc"},{"first_seen_ts":"desc"}] };
}
async function initialDocs(q){
  const res = await fetch(`${base()}/${DB_NAME}/_find`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(findBody(q))
  });
  if (!res.ok) throw new Error(`CouchDB _find ${res.status}`);
  const js = await res.json();
  return js.docs || [];
}
async function fallbackDocs(){
  const res = await fetch('data.json');
  if(!res.ok) throw new Error('No data.json');
  const js = await res.json();
  return js.docs || js;
}

/*** UPSERT + SORT ***/
function keyOf(d){
  // prefer Couch _id, then canonical URL, then a fallback random key
  return d._id || d.url || `k_${Math.random().toString(36).slice(2)}`;
}
function upsert(d){ STORE.set(keyOf(d), d); }
function rebuild(){
  DATA = [...STORE.values()].sort((a,b)=>{
    const ad = toDate(a.published) || toDate(a.first_seen_ts) || new Date(0);
    const bd = toDate(b.published) || toDate(b.first_seen_ts) || new Date(0);
    return bd - ad;
  });
}

/*** RENDER ***/
function render(){
  const start = (PAGE-1)*PAGE_SIZE;
  const items = DATA.slice(start, start+PAGE_SIZE);
  const list = $('#list');
  list.innerHTML = '';

  if (!items.length){
    list.innerHTML = `<div class="empty">No items found. Try a broader search.</div>`;
  } else {
    for (const d of items){
      const url   = d.url || '#';
      const title = d.title || '(untitled)';
      const site  = d.site || safeHost(url);
      const pub   = fmtPub(d.published);
      const seen  = fmtSeen(d.first_seen_ts || d.last_seen_ts);
      const pats  = (d.matched_patterns || []).map(cleanPat).join(', ');
      const snip  = (d.snippet || d.context_snippet || '').toString().trim();
      const img   = d.image || '';

      list.insertAdjacentHTML('beforeend', `
        <article class="card ${img? '' : 'noimg'}">
          ${img ? `<img class="thumb" loading="lazy" src="${img}" alt="">` : ``}
          <div>
            <h2 class="title"><a target="_blank" rel="noopener" href="${url}">${highlight(title)}</a></h2>
            <div class="meta">
              ${pub  !=='—' ? `<span>Published: ${pub}</span>` : ``}
              ${seen !=='—' ? `<span>Seen: ${seen}</span>` : ``}
              ${site        ? `<span>Site: ${site}</span>` : ``}
              ${pats        ? `<span>Matched: ${pats}</span>` : ``}
            </div>
            ${snip ? `<div class="snippet">${highlight(snip)}</div>` : ``}
          </div>
        </article>
      `);
    }
  }

  const pages = Math.max(1, Math.ceil(DATA.length / PAGE_SIZE));
  $('#count').textContent = `${DATA.length} item${DATA.length!==1?'s':''} • page ${PAGE} of ${pages}`;
  $('#prev').disabled = PAGE<=1;
  $('#next').disabled = PAGE>=pages;
}

/*** LIVE CHANGES (long-poll using _selector filter) ***/
async function watchChanges(q){
  if (!ENABLE_LIVE) return;
  const token = ++liveToken;
  $('#live').classList.remove('on');

  let since = 'now';
  const selector = findBody(q).selector;

  while (token === liveToken){
    try{
      const url = `${base()}/${DB_NAME}/_changes?feed=longpoll&since=${encodeURIComponent(since)}&timeout=60000&include_docs=true&filter=_selector`;
      const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({selector})});
      if (!res.ok) throw new Error(`changes ${res.status}`);
      const data = await res.json();

      for (const ch of (data.results||[])){
        if (ch.doc && ch.doc.matched_patterns) upsert(ch.doc);
      }
      if ((data.results||[]).length){
        rebuild();
        render();
      }
      since = data.last_seq || since;
      $('#live').classList.add('on');
    } catch(e){
      $('#live').classList.remove('on');
      await sleep(2000); // brief backoff then retry
    }
  }
}

/*** LOAD orchestrator ***/
async function load(q){
  $('#errors').innerHTML = '';
  PAGE = 1;
  currentQuery = (q||'').trim();
  STORE.clear(); DATA = [];

  try{
    let docs;
    try{
      docs = await initialDocs(currentQuery);
      watchChanges(currentQuery);     // start live listener for this query
    }catch(err){
      liveToken++;                    // cancel any live watcher
      docs = await fallbackDocs();    // file fallback
      if (currentQuery){
        const re = new RegExp(currentQuery, 'i');
        docs = docs.filter(d => re.test(d.title||'') || re.test(d.snippet||'') || re.test(d.context_snippet||''));
      }
      $('#errors').innerHTML = `<div class="err">Using <b>data.json</b> fallback (CouchDB not reachable). ${err.message||err}</div>`;
    }

    docs.forEach(upsert);
    rebuild();
    render();
  }catch(err){
    $('#errors').innerHTML = `<div class="err">Failed to load data: ${err.message||err}</div>`;
  }
}

/*** EVENTS ***/
$('#prev').addEventListener('click', ()=>{ if(PAGE>1){ PAGE--; render(); }});
$('#next').addEventListener('click', ()=>{ const max=Math.ceil(DATA.length/PAGE_SIZE)||1; if(PAGE<max){ PAGE++; render(); }});

let t=null;
$('#q').addEventListener('input', e=>{
  clearTimeout(t);
  t = setTimeout(()=> load(e.target.value), 300);
});

/*** START ***/
load();  // initial load
</script>
</body>
</html>
